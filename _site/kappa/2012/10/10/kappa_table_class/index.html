
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
	<meta property="og:title" content="tsucchi の日記 2nd season" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="http://tsucchi.github.com/" />
	<meta property="og:image" content="" />
	<meta property="og:site_name" content="tsucchi の日記 2nd season" />
	<meta property="fb:admins" content="699059896" />
    <title>Kappa の飼い方(Kappa という ORM の話) その7 テーブルクラスとそのカスタマイズ - tsucchi の日記 2nd season</title>
    
    <meta name="author" content="tsucchi">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/syntax.css" rel="stylesheet" type="text/css" media="screen">
	<style type="text/css">
      .sidebar {
        padding: 0 5px;
      }
	  div.content > h1 {
	    border-left: 15px solid #5279E7;
	    margin-top: 9px;
	    margin-bottom: 9px;
  	    padding-left: 9px;
	  }
	  div.content > h2 {
	    border-left: 12px solid #5279E7;
	    margin-top: 8px;
	    margin-bottom: 8px;
  	    padding-left: 8px;
	  }
	  div.content > h3 {
	    border-left: 10px solid #5279E7;
	    margin-top: 5px;
	    margin-bottom: 5px;
  	    padding-left: 5px;
	  }
	  div.sidebar_box {
        background-color: #F5F5F5;
	  }
    </style>
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://tsucchi.github.com/feed.xml">
  </head>

  <body>
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
	  fjs.parentNode.insertBefore(js, fjs);
	  }(document, 'script', 'facebook-jssdk'));</script>

	<div class="row">
	  <div class="span1">
		&nbsp;
	  </div>
	  <div class="span8">
		<div class="page-title">
		  <h1><a href="/">tsucchi の日記 2nd season</a></h1>
		</div>
		<br>
		<br>
		<div class="page-header">
		  <h1>2012-10-10</h1>
		  <h1>Kappa の飼い方(Kappa という ORM の話) その7 テーブルクラスとそのカスタマイズ</h1> 
		</div>
	  </div>
	  <div class="span3">
		&nbsp;
	  </div>
	</div>
	<div class="row">
	  <div class="span1">
		&nbsp;
	  </div>
	  <div class="span8">
		<div class="content">
          

<div class="pull-right">
  
  


  
     
    	<a href="/tags.html#perl-ref"><span class="label label-info">perl <span>15</span></span></a>
     
    	<a href="/tags.html#db-ref"><span class="label label-info">db <span>10</span></span></a>
     
    	<a href="/tags.html#orm-ref"><span class="label label-info">orm <span>8</span></span></a>
     
    	<a href="/tags.html#kappa-ref"><span class="label label-info">kappa <span>8</span></span></a>
    
  



</div>
  

<p>こんばんはこんばんは。YAPC も(ry もういいか。ずいぶん経つもんね。</p>

<p><a href="https://github.com/tsucchi/p5-Kappa">Kappa</a> という ORM の話。
今日はテーブルクラスとそのカスタマイズ方法についてです。</p>

<h2>目次</h2>

<ul>
<li><a href="/kappa/2012/09/15/kappa_background">その1 開発の背景のお話</a></li>
<li><a href="/kappa/2012/09/17/kappa_install">その2 インストールとかのお話</a></li>
<li><a href="/kappa/2012/09/22/kappa_basic_operation">その3 基本操作</a></li>
<li><a href="/kappa/2012/09/25/kappa_select_and_rowobject">その4 select 系いろいろ</a></li>
<li><a href="/kappa/2012/10/02/kappa_row_object">その5 Row オブジェクトの基本</a></li>
<li><a href="/kappa/2012/10/09/kappa_customized_row_object">その6 Row オブジェクトのカスタマイズ</a></li>
<li><a href="/kappa/2012/10/10/kappa_table_class">その7 テーブルクラスとそのカスタマイズ</a></li>
<li><a href="/kappa/2012/10/23/kappa_misc">その8 雑多な話</a></li>
</ul>


<h2>事前準備</h2>

<p>前回と同じものを使います。</p>

<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&quot;dbi:SQLite:dbname=:memory:&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">);</span>
<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="s">&quot;</span>
<span class="s">CREATE TABLE detective (</span>
<span class="s">  id      INT PRIMARY KEY,</span>
<span class="s">  toys_id INT, /* toys.id */</span>
<span class="s">  name    TEXT</span>
<span class="s">);</span>
<span class="s">&quot;</span><span class="p">);</span>

<span class="nv">$dbh</span><span class="o">-&gt;</span><span class="k">do</span><span class="p">(</span><span class="s">&quot;</span>
<span class="s">CREATE TABLE toys (</span>
<span class="s">  id    INT PRIMARY KEY,</span>
<span class="s">  name  TEXT</span>
<span class="s">);</span>
<span class="s">&quot;</span><span class="p">);</span>
</code></pre>
</div>


<p>スキーマは分かりますよね？ detective.toys_id = toys.id で結合します。(前回と同じ)</p>

<p>メモリ上にテーブルを作っているため、前回入れた人もデータを入れる必要があります。</p>

<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">Kappa</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="n">Kappa</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">,</span> <span class="p">{</span> <span class="n">row_namespace</span> <span class="o">=&gt;</span> <span class="s">&#39;MilkyHolmes::DB::Row&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;toys&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;サイコキネシス&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;toys&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;ダイレクトハック&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;toys&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;トライアセンド&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;toys&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;ハイパーセンシティブ&#39;</span> <span class="p">});</span>

<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">toys_id</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;シャーロック・シェリンフォード&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">toys_id</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;譲崎　ネロ&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">toys_id</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;エルキュール・バートン&#39;</span> <span class="p">});</span>
<span class="nv">$db</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">toys_id</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;コーデリア・グラウカ&#39;</span> <span class="p">});</span>

<span class="c1"># ここより後ろに試したいコードを書きます</span>
</code></pre>
</div>


<h2>テーブルクラスって何？</h2>

<p>Kappa には model() というメソッドがあります。これを呼ぶと、テーブルクラスのインスタンスが返ります。</p>

<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">Kappa</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="n">Kappa</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$model_detective</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">);</span><span class="c1">#detective テーブルのテーブルクラスのインスタンスが返る</span>
</code></pre>
</div>


<p>テーブルクラスはデフォルトのインスタンス(ここでは $db)とほとんど同じですが、自分自身のテーブル名を知っているため、
select/insert/update などの各メソッドを使う際に、テーブル名を省略できるようになります。</p>

<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="n">Kappa</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$model</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$row</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">-&gt;</span><span class="nb">select</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">});</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">({</span> <span class="n">toys_id</span> <span class="o">=&gt;</span> <span class="nb">undef</span> <span class="p">},</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="p">});</span><span class="c1"># トイズがなくなってダメダメにw</span>
<span class="c1"># ...</span>
</code></pre>
</div>


<p>また、テーブルごとにカスタマイズしたメソッドを持てるようになります。</p>

<p>あと、以前 Row オブジェクトの説明で、Row オブジェクトの db() は Kappa のインスタンスと大体同じ、と説明しましたが、
厳密には、この model() メソッドで取り出したインスタンスと同じです。Row オブジェクトは(たいてい)テーブル名を知っている
ため、そのようになっています。</p>

<h2>カスタマイズ方法</h2>

<p>ではテーブルクラスのカスタマイズをします。プロジェクトは前回同様 MilkyHolmes を使います。detective テーブルをカスタマイズ
します。</p>

<p>ファイル名でいうと、lib/MilkyHolmes/DB/Table/detective.pm。 パッケージ名でいうと、MilkyHolmes::DB::Table::detective となります。</p>

<p>前回と似てますが、detective.id を引数にとって、toys.name (トイズの名前)を返す、toys_name_from_detective_id という
メソッドをつけてみましょう。</p>

<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">MilkyHolmes::DB::Table::</span><span class="n">detective</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Kappa)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">toys_name_from_detective_id</span> <span class="p">{</span>
    <span class="k">my</span><span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="c1">#detective テーブルはテーブル名を省略できる。</span>
    <span class="k">my</span> <span class="nv">$row</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">select_row</span><span class="p">({</span> <span class="n">id</span> <span class="o">=&gt;</span> <span class="nv">$id</span> <span class="p">});</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">defined</span> <span class="nv">$row</span> <span class="p">);</span>
    <span class="k">return</span> <span class="nv">$row</span><span class="o">-&gt;</span><span class="n">toys_name</span><span class="p">;</span><span class="c1"># 前回作った toys_name を呼ぶ</span>
<span class="p">}</span>

<span class="mi">1</span><span class="p">;</span>
</code></pre>
</div>


<p>テーブルクラス内では、拡張しているテーブル自身(今回の例では detective)を省略することができます。
つまりテーブルクラス定義内の $self は Kappa のインスタンスではなく、$db->model('テーブル名') したものに
なります。</p>

<h2>カスタマイズしたテーブルクラスの使い方</h2>

<p>Row オブジェクトの場合と同様、このままでは、定義したテーブルクラスを使うことができません。
Kappa に テーブルクラスの定義がどこに置いてあるかを教えてあげる
必要があります。Kappa の new にオプションとして table_namespace というオプションをわたします。</p>

<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="n">Kappa</span><span class="p">;</span>
<span class="c1"># </span>
<span class="c1"># コンストラクタで table_namespace を指定</span>
<span class="c1">#</span>
<span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="n">Kappa</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">,</span> <span class="p">{</span> 
    <span class="n">row_namespace</span>   <span class="o">=&gt;</span> <span class="s">&#39;MilkyHolmes::DB::Row&#39;</span><span class="p">,</span>   <span class="c1">#これは前回していしたやつ</span>
    <span class="n">table_namespace</span> <span class="o">=&gt;</span> <span class="s">&#39;MilkyHolmes::DB::Table&#39;</span><span class="p">,</span> <span class="c1">#テーブルクラスの定義場所を指定</span>
<span class="p">});</span>
</code></pre>
</div>


<p>こうすることで、テーブルクラスの定義が 「MilkyHolmes::DB::Table::テーブル名」 にあることが Kappa さんに伝わります。
これにより、カスタマイズしたメソッドが呼べるようになります。</p>

<div class="highlight"><pre><code class="perl"><span class="k">my</span> <span class="nv">$model</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">(</span><span class="s">&#39;detective&#39;</span><span class="p">);</span>
<span class="nv">$model</span><span class="o">-&gt;</span><span class="n">toys_name_from_detective_id</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1"># =&gt; &#39;サイコキネシス&#39;</span>
</code></pre>
</div>


<h2>共通のメソッドをテーブルクラスに定義したい</h2>

<p>テーブルに依存せず、すべてのテーブルクラスに共通の処理を定義したい場合もあるかと思います。
Row オブジェクトの場合と同じように、Kappa は テーブルクラスの定義を、</p>

<ul>
<li>「table_namespace::テーブル名」 で定義された、テーブル名単位のもの</li>
<li>table_namespace</li>
<li>Kappa (基本機能)</li>
</ul>


<p>の順に検索します。ですので、共通処理は table_namespace におきます。今回の例だと、
MilkyHolmes::DB::Table(ファイル名だと lib/MilkyHolmes/DB/Table.pm )におきます。</p>

<p>たとえば、insert したあとに、id を返す insert_and_last_insert_id を実装してみます。</p>

<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">MilkyHolmes::DB::</span><span class="n">Table</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Kappa)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">insert_and_last_insert_id</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">@args</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="nv">@args</span><span class="p">);</span>
    <span class="c1">#移植性がないのが微妙ですね。。。laset_insert_id 使っても微妙だし。。。</span>
    <span class="k">return</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">dbh</span><span class="o">-&gt;</span><span class="n">sqlite_last_insert_rowid</span><span class="p">();</span>
<span class="p">}</span>

<span class="mi">1</span><span class="p">;</span>
</code></pre>
</div>


<p>カスタマイズしたテーブルクラス(detective テーブルのもの)からも使えるように、親クラスを変更しておきます。</p>

<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">MilkyHolmes::DB::Table::</span><span class="n">detective</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(MilkyHolmes::DB::Table)</span><span class="p">;</span> <span class="c1">#親クラスを変更</span>
<span class="c1"># ...以降は前と同じ</span>
</code></pre>
</div>


<p>ただし、table_namespace に定義した場合、Kappa のインスタンスからは利用できないので、かなり微妙です。
ですので、共通機能は、もう一つ上の、「プロジェクト名::DB」に置くことの方が多いです。(この例では MilkyHolmes::DB)。</p>

<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">MilkyHolmes::</span><span class="n">DB</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Kappa)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>

<span class="c1"># MilkyHolmes::DB::Table から移動</span>
<span class="k">sub </span><span class="nf">insert_and_last_insert_id</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">@args</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="nv">@args</span><span class="p">);</span>
    <span class="c1">#移植性がないのが微妙ですね。。。laset_insert_id 使っても微妙だし。。。</span>
    <span class="k">return</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">dbh</span><span class="o">-&gt;</span><span class="n">sqlite_last_insert_rowid</span><span class="p">();</span>
<span class="p">}</span>

<span class="mi">1</span><span class="p">;</span>
</code></pre>
</div>


<p>で、table_namespace のほうは、この拡張したクラスを継承するようにします。こんな感じ。</p>

<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">MilkyHolmes::DB::</span><span class="n">Table</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(MilkyHolmes::DB)</span><span class="p">;</span><span class="c1"># 親クラス変更</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>

<span class="mi">1</span><span class="p">;</span>
</code></pre>
</div>


<p>で、インスタンス化する対象を Kappa のインスタンスではなく、「プロジェクト名::DB」のインスタンスにします。</p>

<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">MilkyHolmes::</span><span class="n">DB</span><span class="p">;</span>
<span class="c1"># 前は Kappa を new してたところ</span>
<span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="nn">MilkyHolmes::</span><span class="n">DB</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">,</span> <span class="p">{</span> 
    <span class="n">row_namespace</span>   <span class="o">=&gt;</span> <span class="s">&#39;MilkyHolmes::DB::Row&#39;</span><span class="p">,</span> <span class="c1">#これは前回していしたやつ</span>
    <span class="n">table_namespace</span> <span class="o">=&gt;</span> <span class="s">&#39;MilkyHolmes::DB::Table&#39;</span><span class="p">,</span><span class="c1">#テーブルクラスの定義場所を指定</span>
<span class="p">});</span>
</code></pre>
</div>


<p>また、都度 row_namespace や table_namespace を指定するのはだるいので、コンストラクタをオーバーライドするのが
おすすめです。</p>

<div class="highlight"><pre><code class="perl"><span class="nb">package</span> <span class="nn">MilkyHolmes::</span><span class="n">DB</span><span class="p">;</span>
<span class="k">use</span> <span class="n">parent</span> <span class="sx">qw(Kappa)</span><span class="p">;</span>
<span class="k">use</span> <span class="n">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="n">warnings</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">new</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$dbh</span><span class="p">,</span> <span class="nv">$option_href</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>
    <span class="nv">$option_href</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">row_namespace</span><span class="p">}</span>   <span class="o">=</span> <span class="s">&#39;MilkyHolmes::DB::Row&#39;</span><span class="p">;</span>
    <span class="nv">$option_href</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">table_namespace</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;MilkyHolmes::DB::Table&#39;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nv">$class</span><span class="o">-&gt;</span><span class="nn">SUPER::</span><span class="n">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">,</span> <span class="nv">$option_href</span><span class="p">);</span>
    <span class="nb">bless</span> <span class="nv">$self</span><span class="p">,</span> <span class="nv">$class</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># ...</span>
<span class="mi">1</span><span class="p">;</span>
</code></pre>
</div>


<p>こうすると、先ほどの呼び出しは、</p>

<div class="highlight"><pre><code class="perl"><span class="k">use</span> <span class="nn">MilkyHolmes::</span><span class="n">DB</span><span class="p">;</span>
<span class="c1"># 前は Kappa を new してたところ</span>
<span class="k">my</span> <span class="nv">$db</span> <span class="o">=</span> <span class="nn">MilkyHolmes::</span><span class="n">DB</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$dbh</span><span class="p">);</span>
</code></pre>
</div>


<p>とシンプルに書けるようになります。</p>

<h2>なぜテーブルクラスが重要か</h2>

<p>テーブルクラス内では、自分自身のテーブル名を省略できる、というのが最大のポイントです。</p>

<p>テーブル名が省略されていない呼び出しを見つけると、「あれ？この部分はメソッドに切り出して、
省略できるように他のクラスに移動した方がいいんじゃないかな？」と思うようになります。
(そして、その移動したメソッドは他のクラスからも再利用できるかもしれない、ってか出来ることが多い)</p>

<p>DB設計の時点でミスるとダメかもしれませんが、基本的には、テーブル名を省略できるように書いていくだけで、
ある程度キレイな API が作れるようになっています。(Row オブジェクトを上手に作っても多分実現できるのですが、
テーブルクラスでやるほうがずっと簡単です。)</p>

<p>ですので、Kappa においては、Row オブジェクトよりもテーブルクラスのほうが重要な訳です。</p>

<h2>サンプル</h2>

<p>今回も<a href="https://github.com/tsucchi/Kappa-Example/zipball/2012-10-10-kappa_table_class-rev02">動作するサンプル</a>を作成しました。
bin ディレクトリの customized_table_class.pl が今回のサンプルです。lib/MilkyHolmes/ 配下も実装してありますので、確認してみてください。</p>

<h2>まとめ</h2>

<p>今回はテーブルクラスと、そのカスタマイズ方法を解説しました。これで伝わってるのかだいぶ微妙なのですが、
もうちょっと書いていこうと思います。次回は雑多な話をしようかな。多分最終回です。</p>

<p>なにかリクエストや疑問や文句などあれば、twitter(@tsucchi) とかこのブログのコメント欄(使ったこと無いから使えるか分らんけど)とか、はてブとか、
その辺で連絡してみてください。Kappa 自体の要望とかバグなどあれば、@tsucchi か github issue(日本語でいいです。ってか日本語のがいいです)まで。</p>

<p>ではでは。また次回。</p>

<hr>
<div class="fb-like" data-href="http://tsucchi.github.com//kappa/2012/10/10/kappa_table_class" data-send="true" data-width="450" data-show-faces="true"></div>

<div class="twitter-button">
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="tsucchi" data-lang="ja">ツイート</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>

<div class="pagination">
  <ul>
    
    <li class="prev"><a href="/kappa/2012/10/09/kappa_customized_row_object" title="Kappa の飼い方(Kappa という ORM の話) その6 Row オブジェクトのカスタマイズ">&larr; Previous</a></li>
    
    <li><a href="/archive.html">Archive</a></li>
    
    <li class="next"><a href="/mod_perl/2012/10/19/mod_perl_and_data_section" title="mod_perl 環境でも Data::Section::Simple 使えるかも">Next &rarr;</a></li>
    
  </ul>
</div>
<hr>



  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>






		</div>
	  <footer>
		<p>&copy; tsucchi 2012 
		  with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
		  and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
		</p>
	  </footer>
	  </div>
	  <div class="span3">
		<div class="sidebar">
  <div class="rss">
	<h4>RSS</h4>
	<a href="/feed.xml"><img src="/assets/icons/feed-icon-14x14.png" alt="RSS"></a>
  </div>
  <div class="profile sidebar_box">
	<h4>プロフィール</h4>
	<img src="/assets/icons/icon_myself.jpg" alt="アイコン画像が表示できませんでした">
	<dl>
	  <dt>なまえ</dt>
	  <dd>tsucchi</dd>
	  <dt>ないよう</dt>
	  <dd>Perl とか DB とか雑談とか</dd>
	  <dt>活動場所</dt>
	  <dd>埼玉時々東京</dd>

	  <dd><a href="https://twitter.com/tsucchi">@tsucchi(twitter)</a></dd>
	  <dd><a href="http://search.cpan.org/~tsucchi/">CPAN</a></dd>
	  <dd><a href="https://github.com/tsucchi">github</a></dd>
	  <dd><a href="http://d.hatena.ne.jp/tsucchi1022/">はてダ</a></dd>
	  <dd><a href="http://tsucchi.hatenablog.com/">はてブロ</a></dd>
	  <dd><a href="http://booklog.jp/users/tsucchi">Booklog</a></dd>
	</dl>
  </div>
  <div class="search sidebar_box">
	<h4>サイト内検索(google)</h4>
	<form class="well" action="http://www.google.com/search">
	  <input type="hidden" name="hl" value="ja" />
	  <input type="hidden" name="ie" value="Shift_JIS">
	  <input type="hidden" name="oe" value="Shift_JIS">
	  <input type="hidden" value="tsucchi.github.com" name="as_sitesearch" />
	  <input type="text" name="q" maxlength="256" value="" class="input-medium search-query"/>
	  <input type="submit" name="btnG" value="検索" class="btn"/>
	</form>
  </div>
  <div class="articles sidebar_box">
	<h4>Recent Posts</h4>
	<ul class="posts">
	  
	  <li><span>2013-01-14</span> : <a href="/hpc/2013/01/14/supercomputer">スパコンの話。あるいは、僕がちょっとだけ触れたスーパーコンピュータの世界</a></li>
	  
	  <li><span>2013-01-06</span> : <a href="/cpan/2013/01/06/sql_executor">SQL::Executor 0.14 をリリースしました。もしくは ORM とか関連モジュールはこれでいいんじゃね？という話。</a></li>
	  
	  <li><span>2013-01-04</span> : <a href="/misc/2013/01/04/newyear">あけましておめでとうございます</a></li>
	  
	  <li><span>2012-12-31</span> : <a href="/misc/2012/12/31/matome">2012年の振り返り</a></li>
	  
	  <li><span>2012-12-23</span> : <a href="/music/2012/12/23/music">変調された音とそうでない音と</a></li>
	  
	  <li><span>2012-12-14</span> : <a href="/milkyholms/2012/12/14/izsm">ミルキィホームズ ライブ in 武道館の、橘田いずみさんの話</a></li>
	  
	  <li><span>2012-12-07</span> : <a href="/anime/2012/12/07/kurobas">脅迫に屈するのはダメだと思うんだ</a></li>
	  
	  <li><span>2012-11-20</span> : <a href="/misc/2012/11/20/zatsudan">近況あるいは、奇跡も、魔法も、あるんだよって話</a></li>
	  
	  <li><span>2012-11-17</span> : <a href="/misc/2012/11/17/zatsudan">近況あるいは、こんなの絶対おかしいよ、という話</a></li>
	  
	  <li><span>2012-11-09</span> : <a href="/excel/2012/11/09/excel_grayscale_print">Excel でグレースケールの印刷プレビューをする</a></li>
	  
	  <li><a href="/archive.html">...more</a></li>
	</ul>
  </div>
  <div class="tags">
	<h4>タグ</h4>
	<ul class="unstyled">
	    
	  
  
     
    	<li><a href="/tags.html#blog-ref"><span class="label label-info">blog <span>2</span></span></a></li>
     
    	<li><a href="/tags.html#perl-ref"><span class="label label-info">perl <span>15</span></span></a></li>
     
    	<li><a href="/tags.html#Windows-ref"><span class="label label-info">Windows <span>2</span></span></a></li>
     
    	<li><a href="/tags.html#SQL-ref"><span class="label label-info">SQL <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#DB-ref"><span class="label label-info">DB <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#linux-ref"><span class="label label-info">linux <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#security-ref"><span class="label label-info">security <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#雑談-ref"><span class="label label-info">雑談 <span>12</span></span></a></li>
     
    	<li><a href="/tags.html#ruby-ref"><span class="label label-info">ruby <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#test-ref"><span class="label label-info">test <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#RSpec-ref"><span class="label label-info">RSpec <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#プログラミング-ref"><span class="label label-info">プログラミング <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#db-ref"><span class="label label-info">db <span>10</span></span></a></li>
     
    	<li><a href="/tags.html#orm-ref"><span class="label label-info">orm <span>8</span></span></a></li>
     
    	<li><a href="/tags.html#kappa-ref"><span class="label label-info">kappa <span>8</span></span></a></li>
     
    	<li><a href="/tags.html#イベント-ref"><span class="label label-info">イベント <span>2</span></span></a></li>
     
    	<li><a href="/tags.html#yapcasia-ref"><span class="label label-info">yapcasia <span>4</span></span></a></li>
     
    	<li><a href="/tags.html#yapcasia2012-ref"><span class="label label-info">yapcasia2012 <span>4</span></span></a></li>
     
    	<li><a href="/tags.html#sql-ref"><span class="label label-info">sql <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#mod_perl-ref"><span class="label label-info">mod_perl <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#excel-ref"><span class="label label-info">excel <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#印刷-ref"><span class="label label-info">印刷 <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#アニメ-ref"><span class="label label-info">アニメ <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#ミルキィホームズ-ref"><span class="label label-info">ミルキィホームズ <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#音楽-ref"><span class="label label-info">音楽 <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#cpan-ref"><span class="label label-info">cpan <span>1</span></span></a></li>
     
    	<li><a href="/tags.html#スパコン-ref"><span class="label label-info">スパコン <span>1</span></span></a></li>
    
  



	</ul>
  </div>
  <div class="twitter-widget">
	<h4>twitter</h4>
	<a href="https://twitter.com/tsucchi" class="twitter-follow-button" data-show-count="false" data-lang="ja">@tsucchiをフォロー</a>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	<script charset="utf-8" src="http://widgets.twimg.com/j/2/widget.js"></script>
	<script>
	  new TWTR.Widget({
version: 2,
type: 'profile',
rpp: 4,
interval: 30000,
width: 125,
height: 300,
theme: {
shell: {
background: '#333333',
color: '#ffffff'
},
tweets: {
background: '#000000',
color: '#ffffff',
links: '#4aed05'
}
},
features: {
scrollbar: false,
loop: false,
live: false,
behavior: 'all'
}
}).render().setUser('tsucchi').start();

	</script>
  </div>
  <div class="booklog-widget">
	<h4>booklog</h4>
	<script type="text/javascript" src="http://widget.booklog.jp/blogparts/js/booklog_minishelf.js?black_disp" id="booklog_minishelf"></script>
	<script type="text/javascript" src="http://api.booklog.jp/json/tsucchi?category=0&count=15&callback=booklog_minishelf"></script>
  </div>
</div>

	  </div>
    </div> <!-- /container -->
    
  </body>
</html>

